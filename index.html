<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fokus Tag Dashboard Pro</title>
    
    <link rel="icon" type="image/png" href="assets/img/favicon.png"> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://w.soundcloud.com/player/api.js"></script>
    
    <link rel="stylesheet" href="css/style.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="antialiased text-slate-300">
    <main class="h-screen w-screen p-6 flex flex-col gap-6">
        <canvas id="confetti-canvas"></canvas>
        <div class="flex-none grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card flex flex-col items-center justify-center p-6 h-72">
                <div class="relative w-40 h-40 flex items-center justify-center">
                    <svg class="absolute inset-0" viewBox="0 0 120 120">
                        <circle class="text-slate-700" stroke-width="8" stroke="currentColor" fill="transparent" r="52" cx="60" cy="60" />
                        <circle id="progress-circle" class="text-green-500 timer-progress-circle" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="52" cx="60" cy="60" />
                    </svg>
                    <div id="timer-display-wrapper" class="flex flex-col items-center">
                        <div id="timer" class="text-4xl font-bold text-white tabular-nums">45:00</div>
                        <p id="timer-mode" class="text-xs text-slate-400">Fokus</p>
                    </div>
                </div>
                <div class="flex flex-col items-center justify-center h-10 mt-4">
                    <div id="main-controls" class="flex items-center space-x-2">
                        <button id="start-pause-btn" class="text-sm py-2 px-6 rounded-md bg-green-600 hover:bg-green-700 transition w-24">Start</button>
                        <button id="reset-btn" class="text-sm py-2 px-6 rounded-md bg-slate-600 hover:bg-slate-700 transition w-24">Reset</button>
                        <button id="open-set-time-btn" title="Zeit einstellen" class="text-sm p-2 rounded-md bg-slate-600 hover:bg-slate-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </button>
                    </div>
                    <div id="time-set-controls" class="hidden flex items-center space-x-2">
                        <input type="number" id="custom-time-input" class="w-20 bg-slate-900 text-white text-center rounded-md py-2 outline-none focus:ring-2 focus:ring-green-500" min="1" placeholder="Minuten">
                        <button id="confirm-set-time-btn" class="text-sm py-2 px-4 rounded-md bg-green-600 hover:bg-green-700 transition">Set</button>
                        <button id="cancel-set-time-btn" class="text-sm py-2 px-4 rounded-md bg-slate-600 hover:bg-slate-700 transition">Abbrechen</button>
                    </div>
                </div>
                <div class="w-full mt-auto pt-2">
                    <div class="flex justify-between items-center text-xs text-slate-400 mb-1">
                        <div class="flex items-center gap-2">
                            <button id="reset-cycle-btn" title="Zyklus zurücksetzen" class="text-slate-500 hover:text-slate-300 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                            </button>
                            <span id="cycle-progress-text">0/90 Min.</span>
                        </div>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-2">
                        <div id="cycle-progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="card p-4 flex flex-col h-72">
                <div class="flex-none flex justify-between items-center mb-2 px-2">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg font-bold text-white">Focus FM</h2>
                        <button id="edit-music-btn" title="Musik bearbeiten" class="text-blue-500 hover:text-blue-400 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        </button>
<<<<<<< HEAD
=======
                    </div>
                    <div id="sc-player-buttons" class="flex space-x-1 p-1 bg-slate-900 rounded-md">
>>>>>>> 02ad940 (new structure)
                    </div>
                    <div id="sc-player-buttons" class="flex space-x-1 p-1 bg-slate-900 rounded-md">
                        </div>
                </div>
                <div class="flex-grow flex items-center justify-center">
                    <iframe id="soundcloud-player" width="100%" height="100%" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/1107084022&color=%2322c55e&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false&visual=true"></iframe>
                </div>
                <div class="flex-none flex justify-center items-center space-x-6 mt-3">
                    <button id="sc-prev" title="Vorheriger Titel" class="player-control-btn p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="19"></line></svg>
                    </button>
                    <button id="sc-next" title="Nächster Titel" class="player-control-btn p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex-grow card flex flex-col p-6">
            <div class="flex-none mb-4">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold text-white">Tages-Check (Micro-Tasks)</h2>
                        <button id="reset-checklist-btn" title="Checkliste zurücksetzen" class="text-slate-500 hover:text-slate-300 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                        </button>
                        <button id="edit-checklist-btn" title="Checkliste bearbeiten" class="text-blue-500 hover:text-blue-400 transition">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        </button>
                    </div>
                    <span id="progress-text" class="text-sm font-medium text-slate-400">0/0 Erledigt</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            
            <div id="checklist-container" class="flex-grow grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 custom-scroll overflow-y-auto">
                <div id="morgen-start-container" class="bg-slate-900/50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-400 mb-3 text-base">Morgen-Start (Hürde senken)</h3>
                    <ul id="morgen-start-list" class="space-y-3 pl-1 text-sm"></ul>
                </div>
                <div id="fokus-flow-container" class="bg-slate-900/50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-400 mb-3 text-base">Fokus & Flow (Durchhalten)</h3>
                    <ul id="fokus-flow-list" class="space-y-3 pl-1 text-sm"></ul>
                </div>
                <div id="tages-abschluss-container" class="bg-slate-900/50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-400 mb-3 text-base">Tages-Abschluss (Morgen vorbereiten)</h3>
                    <ul id="tages-abschluss-list" class="space-y-3 pl-1 text-sm"></ul>
                </div>
            </div>
        </div>
    </main>

    <div id="cycle-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0">
        <div class="card p-8 rounded-lg text-center max-w-sm transform scale-95 transition-transform duration-300">
            <h3 class="text-2xl font-bold text-blue-400 mb-4">Zeit für eine Pause!</h3>
            <p class="text-slate-300 mb-6">Super! Du hast 90 Minuten fokussiert gearbeitet. Steh auf, streck dich, lüfte und hol dir was zu trinken!</p>
            <button id="close-cycle-modal-btn" class="py-2 px-8 bg-blue-600 hover:bg-blue-700 rounded-md text-white font-semibold">Okay</button>
        </div>
    </div>

    <div id="music-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0">
        <div class="card p-6 rounded-lg text-center max-w-sm transform scale-95 transition-transform duration-300 border border-slate-600">
            <h3 class="text-lg font-bold text-white mb-2">Fokus-Modus starten</h3>
            <p class="text-slate-300 mb-6 text-sm">Soll dazu die Fokus-Musik automatisch gestartet werden?</p>
            <div class="flex justify-center space-x-3">
                <button id="music-no-btn" class="py-2 px-4 bg-slate-600 hover:bg-slate-700 rounded-md text-white text-sm transition">Nein, nur Timer</button>
                <button id="music-yes-btn" class="py-2 px-4 bg-green-600 hover:bg-green-700 rounded-md text-white text-sm font-semibold transition">Ja, Musik abspielen</button>
            </div>
        </div>
    </div>
    
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0">
        <div class="card w-[95vw] max-w-7xl h-[90vh] p-6 rounded-xl text-left transform scale-95 transition-transform duration-300 flex flex-col bg-slate-800 border-slate-700 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-600 pb-3 flex-none">Checkliste bearbeiten</h3>
            <p class="text-xs text-slate-400 mb-4 flex-none">Aufgaben per Drag & Drop verschieben. <b>URL</b> (optional) für externe Links. <b>Zeit</b> (optional) für Timer.</p>
            
            <div id="edit-modal-content" class="flex-grow overflow-hidden grid grid-cols-1 md:grid-cols-3 gap-6 h-full min-h-0">
            </div>

            <div class="flex-none mt-6 pt-4 border-t border-slate-600 flex justify-end space-x-3">
                <button id="cancel-edit-btn" class="py-2 px-6 bg-slate-600 hover:bg-slate-700 rounded-md text-white font-semibold transition">Abbrechen</button>
                <button id="save-edit-btn" class="py-2 px-6 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold transition shadow-lg shadow-green-900/50">Speichern</button>
            </div>
        </div>
    </div>

    <div id="sc-edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0">
        <div class="card w-[95vw] max-w-2xl h-[90vh] p-6 rounded-xl text-left transform scale-95 transition-transform duration-300 flex flex-col bg-slate-800 border-slate-700 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4 border-b border-slate-600 pb-3 flex-none">Focus FM bearbeiten</h3>
            <p class="text-xs text-slate-400 mb-4 flex-none">Füge SoundCloud-Embed-URLs hinzu oder entferne sie. Der <b>Name</b> erscheint auf dem Button.</p>
<<<<<<< HEAD
            
            <div id="sc-edit-list-container" class="flex-grow overflow-y-auto custom-scroll min-h-0 space-y-3 pr-1">
                </div>

            <div class="flex-none mt-6 pt-4 border-t border-slate-600 flex space-x-2">
                 <input type="text" id="new-sc-name-input" placeholder="Name des Tracks/Playlist" class="w-1/3 bg-slate-700 text-sm rounded-md px-2 py-1 focus:ring-blue-500 border border-transparent focus:border-blue-500 outline-none text-slate-200" />
                 <input type="text" id="new-sc-url-input" placeholder="SoundCloud Embed URL (Komplett)" class="flex-grow bg-slate-700 text-sm rounded-md px-2 py-1 focus:ring-blue-500 border border-transparent focus:border-blue-500 outline-none text-slate-200" />
                 <button id="add-sc-track-btn" class="flex-none bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-1 px-3 rounded-md transition">Hinzufügen</button>
            </div>
            
            <div class="flex-none mt-4 pt-4 border-t border-slate-600 flex justify-end space-x-3">
                <button id="cancel-sc-edit-btn" class="py-2 px-6 bg-slate-600 hover:bg-slate-700 rounded-md text-white font-semibold transition">Abbrechen</button>
                <button id="save-sc-edit-btn" class="py-2 px-6 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold transition shadow-lg shadow-green-900/50">Speichern</button>
            </div>
        </div>
    </div>
    <script>
        // --- UTILITY: SAFE UUID ---
        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- POMODORO TIMER SCRIPT ---
        const timerDisplay = document.getElementById('timer');
        const customTimeInput = document.getElementById('custom-time-input');
        const startPauseBtn = document.getElementById('start-pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const progressCircle = document.getElementById('progress-circle');
        const openSetTimeBtn = document.getElementById('open-set-time-btn');
        const mainControls = document.getElementById('main-controls');
        const timeSetControls = document.getElementById('time-set-controls');
        const confirmSetTimeBtn = document.getElementById('confirm-set-time-btn');
        const cancelSetTimeBtn = document.getElementById('cancel-set-time-btn');
        const timerModeDisplay = document.getElementById('timer-mode'); 
        
        // Music Modal Elements
        const musicModal = document.getElementById('music-modal');
        const musicYesBtn = document.getElementById('music-yes-btn');
        const musicNoBtn = document.getElementById('music-no-btn');
        
        const radius = progressCircle.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
        
        let countdown;
        let timeLeft;
        let timerState = 'stopped';
        let initialDuration = 45 * 60;
        let activeTaskTimerId = null; // Stores ID of the task that started the current timer
        let scWidget; // Defined here for global access

        // --- 90 MINUTE CYCLE TRACKER ---
        const cycleProgressBar = document.getElementById('cycle-progress-bar');
        const cycleProgressText = document.getElementById('cycle-progress-text');
        const cycleModal = document.getElementById('cycle-modal');
        const closeCycleModalBtn = document.getElementById('close-cycle-modal-btn');
        const resetCycleBtn = document.getElementById('reset-cycle-btn'); 
        const cycleDuration = 90 * 60;
        let cycleTimeAccumulated = 0;
        const cycleStorageKey = 'focusCycleTime';

        function loadCycleState() {
            const savedTime = localStorage.getItem(cycleStorageKey);
            cycleTimeAccumulated = savedTime ? parseInt(savedTime, 10) : 0;
            updateCycleProgress();
        }

        function saveCycleState() {
            localStorage.setItem(cycleStorageKey, cycleTimeAccumulated);
        }

        function showCycleModal() {
            cycleModal.classList.remove('hidden');
            cycleModal.style.opacity = '0'; 
            cycleModal.querySelector('.card').style.transform = 'scale(0.95)';
            setTimeout(() => { 
                cycleModal.style.opacity = '1';
                cycleModal.querySelector('.card').style.transform = 'scale(1)';
            }, 10);
        }

        function updateCycleProgress() {
            const percentageRaw = cycleDuration > 0 ? (cycleTimeAccumulated / cycleDuration) * 100 : 0;
            const percentage = Math.min(percentageRaw, 100); 
            cycleProgressBar.style.width = `${percentage}%`;
            cycleProgressText.textContent = `${Math.floor(cycleTimeAccumulated / 60)}/90 Min.`;
        }

        closeCycleModalBtn.addEventListener('click', () => {
            cycleModal.style.opacity = '0';
            cycleModal.querySelector('.card').style.transform = 'scale(0.95)';
            setTimeout(() => { cycleModal.classList.add('hidden'); }, 300)
            cycleTimeAccumulated = 0;
            saveCycleState();
            updateCycleProgress();
        });

        resetCycleBtn.addEventListener('click', () => {
            cycleTimeAccumulated = 0;
            saveCycleState();
            updateCycleProgress();
        });

        function setProgress(percent) {
            const offset = circumference - percent / 100 * circumference;
            progressCircle.style.strokeDashoffset = offset;
        }

        function updateDisplay(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            timerDisplay.textContent = `${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
            document.title = `${timerDisplay.textContent} - Fokus Dashboard`;
            const progress = initialDuration > 0 ? ((initialDuration - seconds) / initialDuration) * 100 : 0;
            setProgress(progress);
        }

        function startTimer() {
            if (timeLeft <= 0) return;
            if (timerState === 'running') clearInterval(countdown);
=======
>>>>>>> 02ad940 (new structure)
            
            <div id="sc-edit-list-container" class="flex-grow overflow-y-auto custom-scroll min-h-0 space-y-3 pr-1">
            </div>

            <div class="flex-none mt-6 pt-4 border-t border-slate-600 flex space-x-2">
                 <input type="text" id="new-sc-name-input" placeholder="Name des Tracks/Playlist" class="w-1/3 bg-slate-700 text-sm rounded-md px-2 py-1 focus:ring-blue-500 border border-transparent focus:border-blue-500 outline-none text-slate-200" />
                 <input type="text" id="new-sc-url-input" placeholder="SoundCloud Embed URL (Komplett)" class="flex-grow bg-slate-700 text-sm rounded-md px-2 py-1 focus:ring-blue-500 border border-transparent focus:border-blue-500 outline-none text-slate-200" />
                 <button id="add-sc-track-btn" class="flex-none bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-1 px-3 rounded-md transition">Hinzufügen</button>
            </div>
            
<<<<<<< HEAD
            musicModal.classList.remove('hidden');
            musicModal.style.opacity = '0';
            musicModal.querySelector('.card').style.transform = 'scale(0.95)';
            setTimeout(() => { 
                musicModal.style.opacity = '1';
                musicModal.querySelector('.card').style.transform = 'scale(1)';
            }, 10);
        }

        function closeMusicModal() {
            musicModal.style.opacity = '0';
            musicModal.querySelector('.card').style.transform = 'scale(0.95)';
            setTimeout(() => { musicModal.classList.add('hidden'); }, 300);
        }

        musicYesBtn.addEventListener('click', () => {
            closeMusicModal();
            startTaskTimer(pendingTaskDuration, pendingTaskId, true);
        });

        musicNoBtn.addEventListener('click', () => {
            closeMusicModal();
            startTaskTimer(pendingTaskDuration, pendingTaskId, false);
        });

        function startTaskTimer(minutes, taskId, playMusic) {
            if(!minutes || minutes <= 0) return;
            
            // Visual feedback
            const wrapper = document.getElementById('timer-display-wrapper');
            wrapper.style.transform = 'scale(1.1)';
            setTimeout(() => wrapper.style.transform = 'scale(1)', 200);

            initialDuration = minutes * 60;
            
            // WICHTIGE ÄNDERUNG: Zuerst Reset (dieser löscht normalerweise die ID)
            resetTimer(); 
            
            // DANACH die ID neu setzen, damit sie erhalten bleibt
            activeTaskTimerId = taskId; 
            
            startTimer(); 
            
            if (playMusic && scWidget) {
                scWidget.play();
            }
        }

        function handleTimerEnd() {
            new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3').play();
            
            // AUTOMATICALLY CHECK TASK IF TIMER WAS STARTED BY TASK
            if (activeTaskTimerId) {
                let foundAndChecked = false;
                Object.values(currentChecklistData).forEach(category => {
                    const task = category.tasks.find(t => t.id === activeTaskTimerId);
                    if (task && !task.checked) { 
                        task.checked = true; 
                        foundAndChecked = true;
                    }
                });
                
                if(foundAndChecked) {
                    saveChecklistState();
                    renderChecklist();
                    // Optional: Visual confirmation that task was checked
                    activeTaskTimerId = null;
                }
            }

            if (cycleTimeAccumulated >= cycleDuration) { showCycleModal(); }
            resetTimer();
        }

        startPauseBtn.addEventListener('click', () => {
            if (timerState === 'running') { pauseTimer(); } else { startTimer(); }
        });

        resetBtn.addEventListener('click', resetTimer);
        
        function showTimeInput() {
            mainControls.classList.add('hidden');
            timeSetControls.classList.remove('hidden');
            customTimeInput.value = Math.floor(initialDuration / 60);
            customTimeInput.focus();
        }

        function hideTimeInput() {
            timeSetControls.classList.add('hidden');
            mainControls.classList.remove('hidden');
        }

        openSetTimeBtn.addEventListener('click', () => {
            if (timerState !== 'stopped') { resetTimer(); }
            showTimeInput();
        });

        cancelSetTimeBtn.addEventListener('click', hideTimeInput);

        confirmSetTimeBtn.addEventListener('click', () => {
            const newTime = parseInt(customTimeInput.value, 10);
            if (!isNaN(newTime) && newTime > 0) {
                initialDuration = newTime * 60;
                resetTimer();
            }
            hideTimeInput();
        });

        customTimeInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') confirmSetTimeBtn.click();
            if (e.key === 'Escape') cancelSetTimeBtn.click();
        });

        resetTimer();


        // --- SOUNDCLOUD TRACK MANAGER SCRIPT ---
        const scPlayerButtons = document.getElementById('sc-player-buttons');
        const editMusicBtn = document.getElementById('edit-music-btn');
        const scEditModal = document.getElementById('sc-edit-modal');
        const scEditListContainer = document.getElementById('sc-edit-list-container');
        const saveScEditBtn = document.getElementById('save-sc-edit-btn');
        const cancelScEditBtn = document.getElementById('cancel-sc-edit-btn');
        const addScTrackBtn = document.getElementById('add-sc-track-btn');
        const newScNameInput = document.getElementById('new-sc-name-input');
        const newScUrlInput = document.getElementById('new-sc-url-input');

        const SC_TRACKS_STORAGE_KEY = 'focusDaySCTracks_v1';
        
        // Use the hardcoded tracks as default
        const DEFAULT_SC_TRACKS = [
            { id: 'sc-1', name: "Brown Noise", url: "https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/1107084022&color=%2322c55e&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false&visual=true" },
            { id: 'sc-2', name: "Piano Focus", url: "https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/playlists/soundcloud%253Aplaylists%253A1786226742&color=%2322c55e&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false&visual=true" },
            { id: 'sc-3', name: "Binaural Beats", url: "https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/playlists/soundcloud%253Aplaylists%253A1561633429&color=%2322c55e&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false&visual=true" },
            { id: 'sc-4', name: "Lofi", url: "https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/playlists/1234609288&color=%2322c55e&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false&visual=true" },
        ];
        let currentSCTracks = [];

        // Utility to check if a URL is a valid SoundCloud embed URL
        function isValidSoundCloudEmbed(url) {
            // Very basic check, mainly for the user to paste the full embed link
            return url.startsWith('https://w.soundcloud.com/player/?url=');
        }

        function loadSCTracks() {
            const savedTracks = localStorage.getItem(SC_TRACKS_STORAGE_KEY);
            try {
                const tracks = savedTracks ? JSON.parse(savedTracks) : DEFAULT_SC_TRACKS;
                currentSCTracks = tracks.map(track => ({
                    ...track,
                    id: track.id || generateUUID(), // Ensure all have an ID
                }));
            } catch(e) {
                console.error("Error loading SoundCloud tracks from local storage:", e);
                currentSCTracks = DEFAULT_SC_TRACKS;
            }
        }

        function saveSCTracks() {
            localStorage.setItem(SC_TRACKS_STORAGE_KEY, JSON.stringify(currentSCTracks));
        }

        function renderSCButtons() {
            scPlayerButtons.innerHTML = '';
            
            currentSCTracks.forEach((track, index) => {
                const button = document.createElement('button');
                // The first track is active on load
                button.className = `player-btn text-xs py-1 px-2 rounded ${index === 0 ? 'active' : ''}`;
                button.textContent = track.name;
                button.dataset.src = track.url;
                button.dataset.trackId = track.id; 
                
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.player-btn').forEach(btn => btn.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    loadNewTrack(e.currentTarget.dataset.src);
                });

                scPlayerButtons.appendChild(button);
            });
            
            // Set the initial player iframe source to the first track
            if (currentSCTracks.length > 0) {
                soundcloudPlayerIframe.src = currentSCTracks[0].url;
            }
        }
        
        function openSCEditModal() {
            // Clone data to allow for cancellation
            scEditModal.currentData = JSON.parse(JSON.stringify(currentSCTracks));
            renderSCEditList(scEditModal.currentData);

            scEditModal.classList.remove('hidden');
            scEditModal.style.opacity = '0';
            scEditModal.querySelector('.card').style.transform = 'scale(0.95)';
            setTimeout(() => { 
                scEditModal.style.opacity = '1';
                scEditModal.querySelector('.card').style.transform = 'scale(1)';
            }, 10);
        }

        function closeSCEditModal() {
            scEditModal.style.opacity = '0';
            scEditModal.querySelector('.card').style.transform = 'scale(0.95)';
            setTimeout(() => { scEditModal.classList.add('hidden'); }, 300);
            newScNameInput.value = "";
            newScUrlInput.value = "";
        }

        function renderSCEditList(data) {
            scEditListContainer.innerHTML = '';
            
            data.forEach((track, index) => {
                const li = document.createElement('div');
                li.className = "flex items-center group bg-slate-800/80 p-2 rounded border border-transparent hover:border-slate-600 transition gap-2";
                li.dataset.index = index;
                li.dataset.trackId = track.id;

                // Name Input
                const nameInput = document.createElement('input');
                nameInput.type = "text";
                nameInput.value = track.name;
                nameInput.className = "sc-name-input flex-none w-1/4 bg-transparent text-sm rounded-md px-2 py-1 border-none outline-none text-slate-200 placeholder-slate-500 focus:ring-1 focus:ring-blue-500/50";
                nameInput.dataset.trackId = track.id;
                nameInput.title = "Button Name";

                // URL Input
                const urlInput = document.createElement('input');
                urlInput.type = "text";
                urlInput.value = track.url || "";
                urlInput.className = "sc-url-input flex-grow bg-transparent text-xs rounded-md px-2 py-1 border-none outline-none text-blue-300 placeholder-slate-500 focus:ring-1 focus:ring-blue-500/50";
                urlInput.dataset.trackId = track.id;
                urlInput.title = "SoundCloud Embed URL (Muss komplett sein)";

                // Delete Btn
                const delBtn = document.createElement('button');
                delBtn.className = "action-icon-btn delete-task-btn flex-none";
                delBtn.title = "Löschen";
                delBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';
                
                delBtn.addEventListener('click', () => {
                    syncSCEditModalState(); 
                    scEditModal.currentData.splice(index, 1);
                    renderSCEditList(scEditModal.currentData);
                });

                li.appendChild(nameInput);
                li.appendChild(urlInput);
                li.appendChild(delBtn);

                scEditListContainer.appendChild(li);
            });
        }

        function syncSCEditModalState() {
             const temp = scEditModal.currentData;
             scEditListContainer.querySelectorAll('.sc-name-input').forEach(input => {
                const trackId = input.dataset.trackId;
                const track = temp.find(t => t.id === trackId);
                if (track) track.name = input.value.trim();
             });
             scEditListContainer.querySelectorAll('.sc-url-input').forEach(input => {
                const trackId = input.dataset.trackId;
                const track = temp.find(t => t.id === trackId);
                if (track) track.url = input.value.trim();
             });
        }
        
        function addSCTrack() {
            const name = newScNameInput.value.trim();
            const url = newScUrlInput.value.trim();
            
            if (name === "" || url === "") {
                alert("Bitte einen Namen und die vollständige SoundCloud Embed URL eingeben.");
                return;
            }

            if (!isValidSoundCloudEmbed(url)) {
                 alert("Die URL scheint keine vollständige SoundCloud Embed URL zu sein. Bitte überprüfe, ob es der komplette Embed-Link von SoundCloud ist.");
                 return;
            }
            
            syncSCEditModalState(); 
            const newTrack = { id: generateUUID(), name: name, url: url };
            scEditModal.currentData.push(newTrack);
            renderSCEditList(scEditModal.currentData);
            
            newScNameInput.value = "";
            newScUrlInput.value = "";
            newScNameInput.focus();
        }

        function saveEditedSCTracks() {
            syncSCEditModalState();
            
            const validTracks = scEditModal.currentData.filter(track => 
                track.name !== "" && isValidSoundCloudEmbed(track.url)
            );

            if (validTracks.length === 0) {
                alert("Es muss mindestens ein gültiger SoundCloud-Track mit Namen und Embed-URL vorhanden sein.");
                return;
            }

            currentSCTracks = validTracks;
            saveSCTracks();
            renderSCButtons();
            
            // Re-initialize SC widget to ensure it loads the first track/playlist correctly
            initializeSCWidget();

            closeSCEditModal();
        }

        editMusicBtn.addEventListener('click', openSCEditModal);
        cancelScEditBtn.addEventListener('click', closeSCEditModal);
        saveScEditBtn.addEventListener('click', saveEditedSCTracks);
        addScTrackBtn.addEventListener('click', addSCTrack);
        newScUrlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addSCTrack(); });
        newScNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') newScUrlInput.focus(); });
        // --- END SOUNDCLOUD TRACK MANAGER SCRIPT ---


        // --- CHECKLIST & VISUAL FEEDBACK SCRIPT (V15 + Link Feature) ---
        
        const morningList = document.getElementById('morgen-start-list');
        const focusList = document.getElementById('fokus-flow-list');
        const eveningList = document.getElementById('tages-abschluss-list');
        const editChecklistBtn = document.getElementById('edit-checklist-btn');

        const editModal = document.getElementById('edit-modal');
        const editModalContent = document.getElementById('edit-modal-content');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const resetChecklistBtn = document.getElementById('reset-checklist-btn'); 

        const CHECKED_STATE_KEY = 'focusDayChecklistState_v16';
        const CONTENT_STORAGE_KEY = 'focusDayChecklistContent_v16';

        const DEFAULT_CHECKLIST_DATA = {
            'morgen-start': {
                title: 'Morgen-Start (Hürde senken)',
                tasks: [
                    { id: 'task-m1', text: 'Startzeit loggen', checked: false },
                    { id: 'task-m2', text: 'Erste Stunde → Standingdesk', checked: false },
                    { id: 'task-m3', text: 'Wasserflasche auffüllen', checked: false },
                    { id: 'task-m4', text: 'Mails & Nachrichten checken', checked: false, duration: 15, url: 'https://gmail.com' },
                    { id: 'task-m5', text: 'Kalender checken', checked: false, url: 'https://calendar.google.com' },
                    { id: 'task-m6', text: 'Notizen vom Vortag checken', checked: false },
                    { id: 'task-m7', text: 'Aufgaben für den Tag definieren (max. 3)', checked: false },
                    { id: 'task-m8', text: 'Zeitblöcke planen', checked: false, duration: 10 },
                ]
            },
            'fokus-flow': {
                title: 'Fokus & Flow (Durchhalten)',
                tasks: [
                    { id: 'task-f1', text: '90 min Deepworkphase (Vormittag)', checked: false, duration: 90 },
                    { id: 'task-f2', text: '90 min Deepworkphase (Nachmittag)', checked: false, duration: 90 },
                    { id: 'task-f3', text: 'Focus FM Soundtrack nutzen', checked: false },
                    { id: 'task-f4', text: 'Standing Desk nutzen Nachmittags', checked: false },
                    { id: 'task-f5', text: 'Trinkflasche auffüllen', checked: false },
                ]
            },
            'tages-abschluss': {
                title: 'Tages-Abschluss (Morgen vorbereiten)',
                tasks: [
                    { id: 'task-e1', text: 'Wichtigste Aufgabe für morgen festlegen', checked: false },
                    { id: 'task-e2', text: 'Arbeitszeit loggen (Ende)', checked: false },
                    { id: 'task-e3', text: 'Clear Desk', checked: false, duration: 5 },
                ]
            }
        };

        let currentChecklistData = {};

        function loadChecklistData() {
            const savedContent = localStorage.getItem(CONTENT_STORAGE_KEY);
            let content = savedContent ? JSON.parse(savedContent) : DEFAULT_CHECKLIST_DATA;
            if(!content['morgen-start']) content = DEFAULT_CHECKLIST_DATA;

            const savedState = localStorage.getItem(CHECKED_STATE_KEY);
            const state = savedState ? JSON.parse(savedState) : {};

            for (const categoryKey in content) {
                if (content[categoryKey] && content[categoryKey].tasks) {
                    content[categoryKey].tasks = content[categoryKey].tasks.map(task => ({
                        ...task,
                        checked: state[task.id] || false,
                        duration: task.duration || null,
                        url: task.url || null
                    }));
                }
            }
            currentChecklistData = content;
        }

        function saveChecklistState() {
            const state = {};
            Object.values(currentChecklistData).forEach(category => {
                category.tasks.forEach(task => {
                    state[task.id] = task.checked;
                });
            });
            localStorage.setItem(CHECKED_STATE_KEY, JSON.stringify(state));
        }
        
        function saveChecklistContent() {
            const contentToSave = {};
            for (const key in currentChecklistData) {
                contentToSave[key] = {
                    title: currentChecklistData[key].title,
                    tasks: currentChecklistData[key].tasks.map(({ id, text, duration, url }) => ({ id, text, duration, url }))
                };
            }
            localStorage.setItem(CONTENT_STORAGE_KEY, JSON.stringify(contentToSave));
        }

        function renderChecklist() {
            morningList.innerHTML = '';
            focusList.innerHTML = '';
            eveningList.innerHTML = '';

            const listMap = {
                'morgen-start': morningList,
                'fokus-flow': focusList,
                'tages-abschluss': eveningList
            };

            Object.keys(currentChecklistData).forEach(key => {
                const category = currentChecklistData[key];
                const targetList = listMap[key];
                if (!targetList) return;
                
                const titleEl = document.querySelector(`#${key}-container h3`);
                if(titleEl) titleEl.textContent = category.title;

                category.tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.className = "flex items-center justify-between"; 
                    
                    const leftSide = document.createElement('div');
                    leftSide.className = "flex items-start flex-grow min-w-0";

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = task.id;
                    checkbox.className = "custom-checkbox h-4 w-4 rounded border-slate-600 focus:ring-green-500 mr-3 shrink-0 mt-1";
                    checkbox.checked = task.checked;
                    
                    const label = document.createElement('label');
                    label.htmlFor = task.id;
                    label.className = "text-sm leading-tight pt-[2px] truncate";
                    label.textContent = task.text;

                    leftSide.appendChild(checkbox);
                    leftSide.appendChild(label);
                    li.appendChild(leftSide);
                    
                    const rightSide = document.createElement('div');
                    rightSide.className = "flex items-center gap-2 flex-none ml-2";

                    // LINK BUTTON FALLS URL VORHANDEN
                    if (task.url && task.url.trim() !== '') {
                        const linkBtn = document.createElement('a');
                        linkBtn.href = task.url;
                        linkBtn.target = "_blank";
                        linkBtn.rel = "noopener noreferrer";
                        linkBtn.className = "task-link-btn flex items-center justify-center p-1 rounded-full bg-slate-800 border border-slate-700";
                        linkBtn.title = `Öffne ${task.url}`;
                        linkBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                        `;
                        rightSide.appendChild(linkBtn);
                    }

                    // PLAY BUTTON FALLS ZEIT GESETZT
                    if (task.duration && task.duration > 0) {
                        const playBtn = document.createElement('button');
                        playBtn.className = "task-timer-btn flex items-center gap-1 text-xs bg-slate-800 hover:bg-slate-700 text-green-500 px-2 py-1 rounded border border-slate-700";
                        playBtn.title = `${task.duration} Min. Timer starten`;
                        playBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                            <span>${task.duration}m</span>
                        `;
                        playBtn.onclick = (e) => {
                            e.preventDefault();
                            askToStartMusic(task.id, task.duration);
                        };
                        rightSide.appendChild(playBtn);
                    }
                    
                    li.appendChild(rightSide);
                    targetList.appendChild(li);
                    checkbox.addEventListener('change', handleTaskChange);
                });
            });
            updateProgress();
        }

        function handleTaskChange(e) {
            const taskId = e.target.id;
            const isChecked = e.target.checked;
            let found = false;
            Object.values(currentChecklistData).forEach(category => {
                const task = category.tasks.find(t => t.id === taskId);
                if (task) { task.checked = isChecked; found = true; }
            });
            if (found) { saveChecklistState(); }
            if(isChecked) {
                 const rect = e.target.getBoundingClientRect();
                 const particleCount = 20;
                 const colors = ['#22c55e', '#10b981', '#34d399', '#6ee7b7']; 
                 for (let i = 0; i < particleCount; i++) {
                     particles.push({
                         x: rect.left + rect.width / 2,
                         y: rect.top + rect.height / 2,
                         size: Math.random() * 2 + 1,
                         speedX: (Math.random() - 0.5) * 4,
                         speedY: (Math.random() - 0.5) * 4,
                         color: colors[Math.floor(Math.random() * colors.length)],
                         life: 0.5,
                     });
                 }
            }
            updateProgress();
        }

        function updateProgress() {
            let totalTasks = 0;
            let checkedTasks = 0;
            Object.values(currentChecklistData).forEach(category => {
                category.tasks.forEach(task => {
                    totalTasks++;
                    if (task.checked) checkedTasks++;
                });
            });
            const percentage = totalTasks > 0 ? (checkedTasks / totalTasks) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${checkedTasks}/${totalTasks} Erledigt`;
            if(checkedTasks === totalTasks && totalTasks > 0) triggerConfetti();
        }

        resetChecklistBtn.addEventListener('click', () => {
            if(confirm("Alle Checkboxen zurücksetzen?")) {
                Object.values(currentChecklistData).forEach(category => {
                    category.tasks.forEach(task => { task.checked = false; });
                });
                saveChecklistState();
                renderChecklist(); 
            }
        });

        // --- DRAG AND DROP & EDIT MODAL LOGIC ---
        
        let draggedItemIndex = null;
        let draggedCategoryKey = null;

        function openEditModal() {
            editModal.currentData = JSON.parse(JSON.stringify(currentChecklistData)); 
            renderEditModal(editModal.currentData);
            
            editModal.classList.remove('hidden');
            editModal.style.opacity = '0';
            editModal.querySelector('.card').style.transform = 'scale(0.95)';
            setTimeout(() => { 
                editModal.style.opacity = '1';
                editModal.querySelector('.card').style.transform = 'scale(1)';
            }, 10);
        }

        function closeEditModal() {
            editModal.style.opacity = '0';
            editModal.querySelector('.card').style.transform = 'scale(0.95)';
            setTimeout(() => { editModal.classList.add('hidden'); }, 300);
        }
        
        function renderEditModal(data) {
            editModalContent.innerHTML = '';
            
            Object.keys(data).forEach(key => {
                const category = data[key];
                
                const col = document.createElement('div');
                col.className = 'bg-slate-900/50 p-4 rounded-lg flex flex-col h-full min-h-0'; 
                col.dataset.category = key;
                
                const header = document.createElement('h4');
                header.className = "font-semibold text-white mb-3 text-base border-b border-slate-700 pb-2 flex-none";
                header.textContent = category.title;
                col.appendChild(header);

                const listContainer = document.createElement('ul');
                listContainer.className = "space-y-2 pl-1 text-sm flex-grow overflow-y-auto custom-scroll min-h-0 mb-4 pr-1";
                listContainer.dataset.category = key;
                
                category.tasks.forEach((task, index) => {
                    const li = createEditableTaskItem(task, index, key);
                    listContainer.appendChild(li);
                });
                col.appendChild(listContainer);

                // Footer (Add Button)
                const footer = document.createElement('div');
                footer.className = "flex-none mt-auto pt-2 border-t border-slate-800 flex space-x-2";
                
                const addInput = document.createElement('input');
                addInput.type = "text";
                addInput.placeholder = "Neue Aufgabe...";
                addInput.className = "w-full bg-slate-700 text-sm rounded-md px-2 py-1 focus:ring-blue-500 border border-transparent focus:border-blue-500 outline-none text-slate-200";
                
                const addBtn = document.createElement('button');
                addBtn.textContent = "Add";
                addBtn.className = "flex-none bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold py-1 px-3 rounded-md transition";
                
                const handleAdd = () => {
                    const text = addInput.value.trim();
                    if(text) {
                        syncEditModalState(); 
                        // Empty URL by default
                        const newTask = { id: generateUUID(), text: text, checked: false, duration: null, url: null };
                        editModal.currentData[key].tasks.push(newTask);
                        renderEditModal(editModal.currentData);
                        
                        setTimeout(() => {
                            const lists = editModalContent.querySelectorAll(`ul[data-category="${key}"]`);
                            const currentList = lists[0];
                            if(currentList) {
                                currentList.scrollTop = currentList.scrollHeight;
                                const inputs = currentList.querySelectorAll('input.task-edit-input');
                                const lastInput = inputs[inputs.length - 1];
                                if(lastInput) lastInput.focus();
                            }
                        }, 50);
                    }
                };

                addBtn.addEventListener('click', handleAdd);
                addInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') handleAdd(); });

                footer.appendChild(addInput);
                footer.appendChild(addBtn);
                col.appendChild(footer);

                editModalContent.appendChild(col);
            });
        }

        function createEditableTaskItem(task, index, categoryKey) {
            const li = document.createElement('li');
            li.className = "draggable-item flex items-center group bg-slate-800/80 p-2 rounded border border-transparent hover:border-slate-600 transition gap-2";
            li.draggable = true;
            li.dataset.index = index;
            li.dataset.category = categoryKey;
            li.dataset.taskId = task.id;

            // Handle
            const handle = document.createElement('div');
            handle.className = "drag-handle cursor-grab flex-none";
            handle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="19" r="1"></circle></svg>';
            
            // Text Input
            const input = document.createElement('input');
            input.type = "text";
            input.value = task.text;
            input.className = "task-edit-input flex-grow min-w-0 bg-transparent text-sm rounded-md px-2 py-1 border-none outline-none text-slate-200 placeholder-slate-500 focus:ring-1 focus:ring-blue-500/50";
            input.dataset.taskId = task.id;

            // URL Input
            const urlInput = document.createElement('input');
            urlInput.type = "text";
            urlInput.placeholder = "https://...";
            urlInput.value = task.url || "";
            urlInput.className = "task-url-input w-24 bg-slate-700/50 text-xs rounded-md px-1 py-1 border border-slate-700 outline-none text-blue-300 placeholder-slate-500 focus:ring-1 focus:ring-blue-500/50";
            urlInput.dataset.taskId = task.id;
            urlInput.title = "URL für externen Link (optional)";

            // Timer Input (Minuten)
            const timeInput = document.createElement('input');
            timeInput.type = "number";
            timeInput.placeholder = "Min.";
            timeInput.min = "1";
            timeInput.max = "180";
            if(task.duration) timeInput.value = task.duration;
            timeInput.className = "task-duration-input w-12 text-center bg-slate-700/50 text-xs rounded-md px-1 py-1 border border-slate-700 outline-none text-green-400 placeholder-slate-500 focus:ring-1 focus:ring-green-500/50 tabular-nums";
            timeInput.dataset.taskId = task.id;
            timeInput.title = "Dauer in Minuten für Auto-Timer";

            // Delete Btn
            const delBtn = document.createElement('button');
            delBtn.className = "action-icon-btn delete-task-btn flex-none";
            delBtn.title = "Löschen";
            delBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';
            
            delBtn.addEventListener('click', () => {
                syncEditModalState();
                editModal.currentData[categoryKey].tasks.splice(index, 1);
                renderEditModal(editModal.currentData);
            });

            // Drag Events
            li.addEventListener('dragstart', handleDragStart);
            li.addEventListener('dragover', handleDragOver);
            li.addEventListener('drop', handleDrop);
            li.addEventListener('dragend', handleDragEnd);

            li.appendChild(handle);
            li.appendChild(input);
            li.appendChild(urlInput);
            li.appendChild(timeInput);
            li.appendChild(delBtn);

            return li;
        }

        // --- Drag & Drop Handlers ---
        function handleDragStart(e) {
            syncEditModalState(); 
            draggedItemIndex = parseInt(this.dataset.index);
            draggedCategoryKey = this.dataset.category;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedItemIndex); 
            setTimeout(() => { this.classList.add('dragging'); }, 0);
        }

        function handleDragOver(e) {
            e.preventDefault(); 
            e.dataTransfer.dropEffect = 'move';
            const item = e.target.closest('.draggable-item');
            if(item && item !== this) {
                item.classList.add('drag-over');
            }
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.draggable-item').forEach(item => item.classList.remove('drag-over'));
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();
            
            const targetItem = e.target.closest('.draggable-item');
            if (targetItem) {
                const targetIndex = parseInt(targetItem.dataset.index);
                const targetCategory = targetItem.dataset.category;

                if (draggedCategoryKey === targetCategory && draggedItemIndex !== null) {
                    const tasks = editModal.currentData[draggedCategoryKey].tasks;
                    const itemToMove = tasks[draggedItemIndex];
                    
                    tasks.splice(draggedItemIndex, 1);
                    tasks.splice(targetIndex, 0, itemToMove);
                    
                    renderEditModal(editModal.currentData);
                }
            }
            return false;
        }

        // Helper to sync text, duration and URL inputs to state
        function syncEditModalState() {
             const temp = editModal.currentData;
             // Sync Titles
             editModalContent.querySelectorAll('input.task-edit-input').forEach(input => {
                const taskId = input.dataset.taskId;
                Object.values(temp).forEach(category => {
                    const task = category.tasks.find(t => t.id === taskId);
                    if (task) task.text = input.value; 
                });
             });
             // Sync URLS
             editModalContent.querySelectorAll('input.task-url-input').forEach(input => {
                const taskId = input.dataset.taskId;
                Object.values(temp).forEach(category => {
                    const task = category.tasks.find(t => t.id === taskId);
                    if (task) task.url = input.value.trim() === "" ? null : input.value.trim();
                });
             });
             // Sync Durations
             editModalContent.querySelectorAll('input.task-duration-input').forEach(input => {
                const taskId = input.dataset.taskId;
                Object.values(temp).forEach(category => {
                    const task = category.tasks.find(t => t.id === taskId);
                    if (task) {
                        const val = parseInt(input.value);
                        task.duration = (!isNaN(val) && val > 0) ? val : null;
                    } 
                });
             });
        }

        function saveEditedChecklist() {
            syncEditModalState();
            
            Object.values(editModal.currentData).forEach(category => {
                category.tasks = category.tasks.filter(task => task.text.trim() !== "");
            });
            
            currentChecklistData = editModal.currentData;
            saveChecklistContent();
            saveChecklistState(); 
            renderChecklist();
            closeEditModal();
        }
        
        editChecklistBtn.addEventListener('click', openEditModal);
        cancelEditBtn.addEventListener('click', closeEditModal);
        saveEditBtn.addEventListener('click', saveEditedChecklist);
        

        // --- CONFETTI & SOUNDCLOUD SCRIPT ---
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        
        function triggerConfetti() {
            particles = [];
            const particleCount = 100;
            const colors = ['#22c55e', '#10b981', '#34d399', '#6ee7b7'];
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    size: Math.random() * 5 + 2,
                    speedX: (Math.random() - 0.5) * 8,
                    speedY: Math.random() * 5 + 2,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    life: 1,
                });
            }
        }
        
        function animateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, index) => {
                p.x += p.speedX;
                p.y += p.speedY;
                p.speedY = p.speedY > 20 ? 20 : p.speedY + 0.1; 
                p.life -= 0.01;
                if (p.life <= 0 || p.y > canvas.height) {
                    particles.splice(index, 1);
                } else {
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            requestAnimationFrame(animateConfetti);
        }
        
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        animateConfetti(); 

        // const playerBtns = document.querySelectorAll('.player-btn'); // REMOVED: Now dynamic
        const soundcloudPlayerIframe = document.getElementById('soundcloud-player');
        const scNextBtn = document.getElementById('sc-next');
        const scPrevBtn = document.getElementById('sc-prev');
        // let scWidget; // Moved to top

        function extractApiUrl(embedUrl) {
            try { return decodeURIComponent(new URL(embedUrl).searchParams.get('url')); } catch (e) { return null; }
        }
        
        function initializeSCWidget() {
            if (typeof SC !== 'undefined' && typeof SC.Widget === 'function') {
                scWidget = SC.Widget(soundcloudPlayerIframe);
            }
        }
        
        function loadNewTrack(embedUrl) {
            if(timerState === 'running') pauseTimer();
            if (scWidget) {
                const trackUrl = extractApiUrl(embedUrl);
                if (trackUrl) {
                    // Note: auto_play is false here, as play is triggered separately by the user in the new UI.
                    scWidget.load(trackUrl, { auto_play: false, show_comments: false, show_user: false, show_reposts: false, color: '22c55e' });
                }
            } else { soundcloudPlayerIframe.src = embedUrl; }
        }
        
        /* OLD: Removed hardcoded button logic
        playerBtns.forEach(button => {
            button.addEventListener('click', (e) => {
                playerBtns.forEach(btn => btn.classList.remove('active'));
                e.currentTarget.classList.add('active');
                loadNewTrack(e.currentTarget.dataset.src);
            });
        });
        */

        scNextBtn.addEventListener('click', () => { if (scWidget) scWidget.next(); });
        scPrevBtn.addEventListener('click', () => { if (scWidget) scWidget.prev(); });

        document.addEventListener('DOMContentLoaded', () => {
            loadSCTracks(); // NEW: Load track data
            renderSCButtons(); // NEW: Render dynamic buttons
            loadChecklistData(); 
            renderChecklist();
            loadCycleState();
            initializeSCWidget(); 
        });

    </script>
=======
            <div class="flex-none mt-4 pt-4 border-t border-slate-600 flex justify-end space-x-3">
                <button id="cancel-sc-edit-btn" class="py-2 px-6 bg-slate-600 hover:bg-slate-700 rounded-md text-white font-semibold transition">Abbrechen</button>
                <button id="save-sc-edit-btn" class="py-2 px-6 bg-green-600 hover:bg-green-700 rounded-md text-white font-semibold transition shadow-lg shadow-green-900/50">Speichern</button>
            </div>
        </div>
    </div>
    
    <script type="module" src="js/utils.js"></script>
    <script type="module" src="js/confetti.js"></script>
    <script type="module" src="js/music.js"></script>
    <script type="module" src="js/timer.js"></script>
    <script type="module" src="js/checklist.js"></script>
    <script type="module" src="js/main.js"></script>
>>>>>>> 02ad940 (new structure)
</body>
</html>